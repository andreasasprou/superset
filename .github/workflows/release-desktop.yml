name: Release Desktop App

on:
  push:
    branches:
      - release
    paths:
      - 'apps/desktop/**'
  workflow_dispatch:
    inputs:
      skip_version_bump:
        description: "Skip auto version bump (use current package.json version)"
        required: false
        type: boolean
        default: false

# Prevent concurrent releases from racing
concurrency:
  group: release-desktop
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  version:
    name: Bump Version & Create Tag
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.bump.outputs.version }}
      tag: ${{ steps.bump.outputs.tag }}
      sha: ${{ steps.bump.outputs.sha }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # Prevent infinite loop: skip if this commit was made by the bot
      - name: Check if triggered by version bump
        id: check
        run: |
          AUTHOR=$(git log -1 --pretty=format:'%an')
          MESSAGE=$(git log -1 --pretty=format:'%s')
          if [[ "$AUTHOR" == "github-actions[bot]" ]] && [[ "$MESSAGE" == *"chore: bump desktop version"* ]]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "Skipping: this commit is a version bump from the bot"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Git
        if: steps.check.outputs.skip != 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Setup Bun (for lockfile update)
        if: steps.check.outputs.skip != 'true'
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: '1.3.2'

      - name: Bump version and create tag
        if: steps.check.outputs.skip != 'true'
        id: bump
        run: |
          cd apps/desktop
          
          # Get current version
          CURRENT=$(jq -r '.version' package.json)
          echo "Current version: $CURRENT"
          
          if [[ "${{ inputs.skip_version_bump }}" == "true" ]]; then
            NEW=$CURRENT
            echo "Skipping version bump, using: $NEW"
          else
            # Increment patch version (1.0.5 â†’ 1.0.6)
            NEW=$(echo $CURRENT | awk -F. '{print $1"."$2"."$3+1}')
            echo "New version: $NEW"
          fi
          
          TAG="v$NEW"
          
          # FAIL FAST if tag already exists (prevents building wrong code)
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "::error::Tag $TAG already exists! Manually bump version in package.json or delete the existing tag."
            exit 1
          fi
          
          if [[ "${{ inputs.skip_version_bump }}" != "true" ]]; then
            # Update package.json
            jq --arg v "$NEW" '.version = $v' package.json > tmp.json && mv tmp.json package.json
            
            # Update lockfile to reflect version change (go to repo root)
            cd ../..
            bun install --no-save
            
            # Commit version bump AND lockfile
            git add apps/desktop/package.json bun.lock
            git commit -m "chore: bump desktop version to $NEW [skip ci]"
            git push origin release
          fi
          
          # Capture the exact SHA we're tagging
          SHA=$(git rev-parse HEAD)
          echo "Tagging SHA: $SHA"
          
          # Create and push tag on this exact SHA
          git tag "$TAG" "$SHA"
          git push origin "$TAG"
          
          echo "version=$NEW" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "sha=$SHA" >> $GITHUB_OUTPUT

      - name: Skip remaining jobs if bot commit
        if: steps.check.outputs.skip == 'true'
        run: |
          echo "version=" >> $GITHUB_OUTPUT
          echo "tag=" >> $GITHUB_OUTPUT
          echo "sha=" >> $GITHUB_OUTPUT

  build:
    name: Build - macOS (${{ matrix.arch }})
    needs: version
    if: needs.version.outputs.sha != ''
    runs-on: macos-latest
    # environment: production  # Optional: uncomment to require approval before builds

    strategy:
      fail-fast: false
      matrix:
        arch: [arm64]

    steps:
      - name: Checkout code at exact SHA
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.version.outputs.sha }}

      - name: Verify version matches expected
        run: |
          ACTUAL=$(jq -r '.version' apps/desktop/package.json)
          EXPECTED="${{ needs.version.outputs.version }}"
          if [[ "$ACTUAL" != "$EXPECTED" ]]; then
            echo "::error::Version mismatch! Expected $EXPECTED but found $ACTUAL"
            exit 1
          fi
          echo "Version verified: $ACTUAL"

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: '1.3.2'

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ needs.version.outputs.sha }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install

      - name: Clean dev folder
        working-directory: apps/desktop
        run: bun run clean:dev

      - name: Compile app with electron-vite
        working-directory: apps/desktop
        env:
          NEXT_PUBLIC_POSTHOG_KEY: ${{ secrets.NEXT_PUBLIC_POSTHOG_KEY }}
          NEXT_PUBLIC_POSTHOG_HOST: ${{ secrets.NEXT_PUBLIC_POSTHOG_HOST }}
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GH_CLIENT_ID: ${{ secrets.GH_CLIENT_ID }}
          NEXT_PUBLIC_WEB_URL: ${{ secrets.NEXT_PUBLIC_WEB_URL }}
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}
          SENTRY_DSN_DESKTOP: ${{ secrets.SENTRY_DSN_DESKTOP }}
        run: bun run compile:app

      - name: Build Electron app
        working-directory: apps/desktop
        env:
          CSC_LINK: ${{ secrets.MAC_CERTIFICATE }}
          CSC_KEY_PASSWORD: ${{ secrets.MAC_CERTIFICATE_PASSWORD }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: bun run package -- --publish never

      - name: Upload DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: desktop-mac-${{ matrix.arch }}-dmg
          path: apps/desktop/release/*.dmg
          retention-days: 30
          if-no-files-found: error

      - name: Upload ZIP artifact
        uses: actions/upload-artifact@v4
        with:
          name: desktop-mac-${{ matrix.arch }}-zip
          path: apps/desktop/release/*.zip
          retention-days: 30
          if-no-files-found: error

      - name: Upload auto-update manifest
        uses: actions/upload-artifact@v4
        with:
          name: desktop-mac-update-manifest
          path: apps/desktop/release/latest-mac.yml
          retention-days: 30
          if-no-files-found: error

  release:
    name: Create GitHub Release
    needs: [version, build]
    if: needs.version.outputs.sha != ''
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts
          merge-multiple: true

      - name: Create stable-named copies for latest download URLs
        run: |
          cd release-artifacts
          for file in *.dmg; do
            if [[ -f "$file" ]]; then
              arch=$(echo "$file" | sed -E 's/.*-([^-]+)\.dmg$/\1/')
              cp "$file" "Superset-${arch}.dmg"
              echo "Created stable copy: Superset-${arch}.dmg"
            fi
          done
          for file in *-mac.zip; do
            if [[ -f "$file" ]]; then
              arch=$(echo "$file" | sed -E 's/.*-([^-]+)-mac\.zip$/\1/')
              cp "$file" "Superset-${arch}-mac.zip"
              echo "Created stable copy: Superset-${arch}-mac.zip"
            fi
          done
          echo "Release artifacts:"
          ls -la

      # IMPORTANT: draft: false is required for auto-updates to work
      # The /releases/latest/download URL only serves PUBLISHED releases
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.version.outputs.tag }}
          files: release-artifacts/*
          draft: false
          generate_release_notes: true
          name: Superset Desktop ${{ needs.version.outputs.version }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
